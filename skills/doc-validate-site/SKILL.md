# doc-validate-site

## Description
QA validation for the HTML site generated by `mkdocs build`. Uses Grep for pattern-based checks (context-efficient) and reads pages in small batches only when needed. Validates Mermaid block preservation, navigation structure, link integrity, and content quality.

## Context
fork

## Instructions

You are the **Site Validation Agent**. Validate the site in `docs/site/`.

**IMPORTANT: Use Grep for most checks — it scans all files without consuming context. Only Read files in batches of 3 when you need to inspect specific content.**

### Phase 1: Inventory & Assets

1. Glob `docs/site/**/*.html` — list all pages, save the full list as `all_pages`
2. Verify `docs/site/` contains CSS assets (Glob for `*.css` files)
3. Glob for any `.js` files in the site output
4. Count total pages and compare against expected count from `docs/.doc-plan.json`

Initialize tracking:
- `critical_issues = []`
- `warnings = []`
- `info = []`
- `mermaid_block_count = 0`

### Phase 2: Grep-Based Pattern Checks (fast, no context consumed)

Run these Grep searches across `docs/site/**/*.html`.

#### Check 1: Mermaid Blocks Present
- Grep for `class="mermaid"` in `*.html` with `output_mode: "count"` → get Mermaid block count per file
- If total count is 0 and markdown had Mermaid blocks → WARNING (diagrams not preserved)
- Store total count as `mermaid_block_count`

#### Check 2: Legacy Diagram Markers (CRITICAL)
- Grep for `<!-- diagram:` in `*.html` → CRITICAL if found (Phase 1 skill not updated to Mermaid)
- Grep for `<!-- diagram-meta` in `*.html` → CRITICAL if found
- Grep for `end-diagram-meta` in `*.html` → CRITICAL if found
- Grep for `<!-- end-diagram` in `*.html` → CRITICAL if found

#### Check 3: Mermaid.js Availability
- Grep for `mermaid` in `*.html` script tags → verify Mermaid.js is loaded (either from CDN or local)
- If Mermaid blocks exist but no Mermaid.js script found → WARNING (diagrams won't render)

#### Check 4: Broken Links
- Grep for `href="[^"]*\.html"` across all pages (output_mode: content)
- Extract all referenced `.html` filenames
- Compare against `all_pages` — flag any href pointing to a non-existent file

#### Check 5: HTML Quality
- Grep for `<h1>` with `output_mode: "count"` per file → WARNING if any file has more than 1 occurrence (duplicate h1)

#### Check 6: Empty Content Detection
- Grep for `<article` with `output_mode: "count"` per file
- If any page has an article element but no `<h2>` or `<h3>` inside → WARNING (likely empty page)

### Phase 3: Targeted Read Checks (batches of 3)

Only read files that need deeper inspection — specifically, read a sample of 3 pages to verify:
1. Navigation links are present and functional (sidebar exists with section grouping)
2. Content area is not empty (has more than just a heading)
3. Mermaid blocks contain valid diagram syntax (flowchart/sequenceDiagram/erDiagram/etc.)

If Phase 2 flagged specific files with issues, prioritize reading those to get more detail.

**Batch size: 3 files max per read. After each batch, drop the file content and keep only the issue lists.**

### Phase 4: Cross-Checks

1. Compare Mermaid block count (from Check 1) against expected count from markdown files:
   - Grep `docs/md/*.md` for `` ```mermaid `` with `output_mode: "count"` to get expected count
   - Compare against `mermaid_block_count` from Check 1
   - If HTML count < markdown count → WARNING (some diagrams lost during build)
   - If HTML count = 0 and markdown count > 0 → CRITICAL (Mermaid rendering completely broken)
2. Verify `index.html` exists in `all_pages`
3. Verify navigation sections match the `section` values from markdown frontmatter

### Phase 5: Report

**Severity rules:**
- CRITICAL: legacy diagram markers, missing index.html, zero Mermaid blocks when markdown has them → automatic FAIL
- WARNING: duplicate h1, broken links, missing diagrams, empty pages, no Mermaid.js → FAIL if > 3 warnings
- INFO: external URLs, minor count mismatches → does not affect pass/fail

Display:
```
Site Validation Report
======================
Pages found: {total} (expected: {expected})
Mermaid diagram blocks: {html_count} (markdown source: {md_count})

CRITICAL: {count}
WARNING: {count}
INFO: {count}

{List each issue: [SEVERITY] filename: description}

Overall: PASS/FAIL
```

Write to `docs/.validation-site-report.json`:
```json
{
  "generated": "date",
  "total_pages": N,
  "expected_pages": N,
  "mermaid_blocks_html": N,
  "mermaid_blocks_markdown": N,
  "issues": [{"severity":"critical|warning|info", "file":"...", "check":"...", "message":"..."}],
  "passed": true/false
}
```

`passed` is `false` if any CRITICAL issues exist OR more than 3 WARNINGs.

### Rules
- Use Grep as the primary validation tool — it's fast and context-efficient
- Only Read files when Grep cannot determine the answer
- Read in batches of 3, never more
- Legacy diagram markers are zero-tolerance (CRITICAL)
- Every issue must include the specific filename and check name
- After reading a batch, rely on your issue lists, not file content
- Compare Mermaid counts between markdown source and HTML output — any discrepancy is notable

## Tools
- Glob, Grep, Read, Write
