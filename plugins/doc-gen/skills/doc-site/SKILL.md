# doc-site

## Description
Phase 2 site generator: runs `mkdocs build` to convert markdown documentation with Mermaid diagrams into a static HTML/CSS site. Uses local Mermaid.js for diagram display (works offline and via file:// protocol).

## Context
fork

## Instructions

You are the **Site Generator Agent**. You convert Phase 1 markdown output into a polished static HTML documentation site by running `mkdocs build`.

### Inputs

1. Read `docs/.doc-plan.json` — get project metadata
2. Glob `docs/md/*.md` — get all markdown files
3. Read frontmatter from each markdown file to build navigation

### Step 1: Verify Prerequisites

1. Verify `docs/md/` has markdown files — if empty, tell the user to run `/doc-generate` first and stop
2. Verify `mkdocs` is installed: run `which mkdocs` — if not found, tell the user to install it with `pip install mkdocs mkdocs-material pymdown-extensions`

### Step 2: Create or Update mkdocs.yml

If `mkdocs.yml` does not exist, create it. The configuration should include:

```yaml
site_name: {Project Name} Documentation
docs_dir: docs/md
site_dir: docs/site

use_directory_urls: false

theme:
  name: material
  features:
    - navigation.instant
    - navigation.sections
    - navigation.expand
    - navigation.top
    - search.highlight
    - content.code.copy
  palette:
    scheme: default
    primary: blue
    accent: blue

plugins:
  - search

markdown_extensions:
  - toc:
      permalink: true
  - admonition
  - pymdownx.details
  - pymdownx.superfences:
      custom_fences:
        - name: mermaid
          class: mermaid
          format: !!python/name:pymdownx.superfences.fence_code_format
  - pymdownx.tabbed:
      alternate_style: true
  - pymdownx.highlight:
      anchor_linenums: true
  - pymdownx.inlinehilite
  - attr_list
  - md_in_html
  - tables

extra_javascript:
  - js/mermaid.min.js
  - js/mermaid-init.js

nav:
  # Generated from frontmatter
```

### Step 3: Generate Navigation from Frontmatter

Read frontmatter from all markdown files. Build a `nav:` section grouped by `section` and ordered by `order`:

```yaml
nav:
  - Home: index.md
  - Architecture:
    - Overview: arch-overview.md
    - C4 Level 1 — System Context: arch-c4-level1.md
    - C4 Level 2 — Containers: arch-c4-level2.md
  - API:
    - Endpoint Index: api-index.md
  - Data:
    - Overview: data-overview.md
    - Schema: data-schema.md
```

Update the `nav:` section in `mkdocs.yml` with the generated navigation.

### Step 4: Download Mermaid.js Locally

Download Mermaid.js to `docs/md/js/` if it doesn't exist (required for file:// protocol and offline use):

```bash
mkdir -p docs/md/js
if [ ! -f docs/md/js/mermaid.min.js ]; then
  curl -o docs/md/js/mermaid.min.js https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js
fi
```

### Step 5: Create Mermaid Init Script

Create `docs/md/js/mermaid-init.js` if it doesn't exist:

```javascript
// Fix MkDocs structure: move content from <code> to parent <pre>
document.querySelectorAll('pre.mermaid > code').forEach(function(codeEl) {
    var preEl = codeEl.parentElement;
    preEl.textContent = codeEl.textContent;
});

// Initialize Mermaid.js
mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose'
});
```

### Step 6: Create Index Page

If `docs/md/index.md` does not exist, create it with:
- Project name from `.doc-plan.json`
- Brief description
- Links to each section's overview page
- Generation date

### Step 7: Run MkDocs Build

```bash
mkdocs build
```

This will:
- Convert all markdown to HTML using Material for MkDocs theme
- Preserve ` ```mermaid ` blocks as `<pre class="mermaid">` elements
- Include local Mermaid.js for client-side diagram rendering (works via file:// and offline)
- Output the complete site to `docs/site/`

### Step 8: Verify Output

After the build completes:

1. **Count HTML pages**: Glob `docs/site/**/*.html` — verify count matches markdown file count
2. **Count Mermaid blocks**: Grep for `class="mermaid"` across all HTML files — verify diagrams are present
3. **Check for legacy markers**: Grep for `<!-- diagram-meta` or `<!-- diagram:` in HTML files — CRITICAL if found

Display:
```
Site Build Complete
====================
HTML pages: {count}
Mermaid diagram blocks: {count}
Legacy diagram markers: {count} (must be 0)

Site location: docs/site/
Open: docs/site/index.html
```

### Rules
- Mermaid.js renders diagrams client-side in the browser — no server-side conversion needed
- Do not modify the generated HTML after `mkdocs build`
- Zero legacy `<!-- diagram:` markers — if any remain, Phase 1 skills need updating

## Tools
- Read
- Glob
- Grep
- Write
- Bash (for running mkdocs build)

## Output
Complete static site in `docs/site/` (generated by mkdocs build)
Updated `mkdocs.yml` with navigation
